<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connect 4 ğŸ®</title>
    <style>
        /* ä¿æŒåŸæœ‰æ ·å¼ï¼Œç•¥... */
    </style>
</head>
<body>
    <div class="container">
        <!-- ä¿æŒåŸæœ‰HTMLç»“æ„ï¼Œç•¥... -->
    </div>
    
    <script>
        // ä¿®å¤ç‰ˆæœ¬ï¼šä½¿ç”¨sessionStorage + æ ‡ç­¾é¡µå”¯ä¸€æ ‡è¯†
        class FixedConnect4 {
            constructor() {
                // ç”Ÿæˆæ ‡ç­¾é¡µå”¯ä¸€ID
                this.tabId = 'tab_' + Date.now() + '_' + Math.random().toString(36).substr(2, 8);
                this.playerId = this.tabId + '_player';
                this.roomId = null;
                this.playerColor = null;
                this.board = this.createEmptyBoard();
                this.currentTurn = 'red';
                this.gameActive = false;
                
                console.log('æ ‡ç­¾é¡µID:', this.tabId);
                
                this.init();
                
                // å®šæœŸåŒæ­¥ï¼ˆä½¿ç”¨sessionStorageï¼‰
                setInterval(() => this.syncGameState(), 1000);
            }
            
            init() {
                this.renderBoard();
                document.getElementById('joinGameBtn').onclick = () => this.smartJoin();
                document.getElementById('resetGameBtn').onclick = () => this.resetGame();
                this.updateStatus('ç‚¹å‡» Join Game');
            }
            
            async smartJoin() {
                const btn = document.getElementById('joinGameBtn');
                btn.disabled = true;
                btn.innerHTML = 'æ™ºèƒ½åŒ¹é…ä¸­...';
                
                // ä½¿ç”¨sessionStorageï¼ˆæ ‡ç­¾é¡µç‹¬ç«‹ï¼‰
                const waitingRooms = this.getWaitingRooms();
                
                if (waitingRooms.length > 0) {
                    // å°è¯•åŠ å…¥ç¬¬ä¸€ä¸ªç­‰å¾…æˆ¿é—´
                    const room = waitingRooms[0];
                    const success = this.tryJoinRoom(room.id);
                    
                    if (success) {
                        this.playerColor = 'yellow';
                        this.updateStatus('âœ… ä½ æ˜¯é»„æ–¹ï¼æ¸¸æˆå¼€å§‹ï¼', 'yellow');
                        document.getElementById('redPlayer').textContent = 'å¯¹æ‰‹';
                        document.getElementById('yellowPlayer').textContent = 'ä½ ';
                    } else {
                        // åŠ å…¥å¤±è´¥ï¼Œåˆ›å»ºæ–°æˆ¿é—´
                        this.createNewRoom();
                    }
                } else {
                    // æ²¡æœ‰ç­‰å¾…æˆ¿é—´ï¼Œåˆ›å»ºæ–°æˆ¿é—´
                    this.createNewRoom();
                }
                
                this.updateUI();
            }
            
            getWaitingRooms() {
                // ä»sessionStorageè·å–ï¼ˆæ ‡ç­¾é¡µç‹¬ç«‹ï¼‰
                try {
                    const roomsJson = sessionStorage.getItem('connect4_rooms');
                    if (!roomsJson) return [];
                    
                    const rooms = JSON.parse(roomsJson);
                    const now = Date.now();
                    
                    // è¿‡æ»¤ï¼šç­‰å¾…ä¸­ + ä¸æ˜¯æœ¬æ ‡ç­¾é¡µåˆ›å»º + æœªè¶…æ—¶ï¼ˆ5åˆ†é’Ÿï¼‰
                    return rooms.filter(room => 
                        room.status === 'waiting' && 
                        room.createdBy !== this.tabId &&
                        (now - room.createdAt) < 5 * 60 * 1000
                    );
                } catch {
                    return [];
                }
            }
            
            tryJoinRoom(roomId) {
                try {
                    const roomsJson = sessionStorage.getItem('connect4_rooms');
                    if (!roomsJson) return false;
                    
                    const rooms = JSON.parse(roomsJson);
                    const roomIndex = rooms.findIndex(r => r.id === roomId && r.status === 'waiting');
                    
                    if (roomIndex === -1) return false;
                    
                    // åŸå­æ“ä½œï¼šæ ‡è®°æˆ¿é—´ä¸ºå·²å ç”¨
                    rooms[roomIndex].status = 'playing';
                    rooms[roomIndex].player2 = this.playerId;
                    rooms[roomIndex].occupiedBy = this.tabId;
                    
                    sessionStorage.setItem('connect4_rooms', JSON.stringify(rooms));
                    
                    this.roomId = roomId;
                    this.gameActive = true;
                    return true;
                    
                } catch {
                    return false;
                }
            }
            
            createNewRoom() {
                this.roomId = 'room_' + Date.now();
                this.playerColor = 'red';
                this.gameActive = true;
                
                const room = {
                    id: this.roomId,
                    createdBy: this.tabId,
                    player1: this.playerId,
                    player2: null,
                    board: this.board,
                    currentTurn: 'red',
                    status: 'waiting',
                    createdAt: Date.now(),
                    occupiedBy: null
                };
                
                this.saveRoom(room);
                
                this.updateStatus('âœ… ä½ æ˜¯çº¢æ–¹ï¼ç­‰å¾…é»„æ–¹...', 'red');
                document.getElementById('redPlayer').textContent = 'ä½ ';
                document.getElementById('yellowPlayer').textContent = 'ç­‰å¾…ä¸­...';
            }
            
            saveRoom(room) {
                const roomsJson = sessionStorage.getItem('connect4_rooms');
                let rooms = [];
                
                if (roomsJson) {
                    rooms = JSON.parse(roomsJson);
                    // æ¸…ç†æ—§æˆ¿é—´
                    const now = Date.now();
                    rooms = rooms.filter(r => (now - r.createdAt) < 10 * 60 * 1000);
                }
                
                const existingIndex = rooms.findIndex(r => r.id === room.id);
                if (existingIndex !== -1) {
                    rooms[existingIndex] = room;
                } else {
                    rooms.push(room);
                }
                
                sessionStorage.setItem('connect4_rooms', JSON.stringify(rooms));
            }
            
            syncGameState() {
                if (!this.roomId || !this.gameActive) return;
                
                const roomsJson = sessionStorage.getItem('connect4_rooms');
                if (!roomsJson) return;
                
                const rooms = JSON.parse(roomsJson);
                const room = rooms.find(r => r.id === this.roomId);
                
                if (!room) return;
                
                // æ›´æ–°æ£‹ç›˜
                if (JSON.stringify(room.board) !== JSON.stringify(this.board)) {
                    this.board = room.board;
                    this.renderBoard();
                }
                
                // æ›´æ–°å›åˆ
                if (room.currentTurn !== this.currentTurn) {
                    this.currentTurn = room.currentTurn;
                    this.updateUI();
                }
                
                // çº¢æ–¹çœ‹åˆ°é»„æ–¹åŠ å…¥
                if (this.playerColor === 'red' && room.status === 'playing' && room.player2) {
                    this.updateStatus('ğŸ® å¯¹æ‰‹å·²åŠ å…¥ï¼çº¢æ–¹å…ˆæ‰‹', 'red');
                }
            }
            
            makeMove(col) {
                if (!this.gameActive || this.currentTurn !== this.playerColor) {
                    this.updateStatus('ä¸æ˜¯ä½ çš„å›åˆï¼');
                    return;
                }
                
                for (let row = 5; row >= 0; row--) {
                    if (this.board[row][col] === 0) {
                        this.board[row][col] = this.playerColor === 'red' ? 1 : 2;
                        this.renderBoard();
                        
                        this.currentTurn = this.currentTurn === 'red' ? 'yellow' : 'red';
                        
                        // ä¿å­˜åˆ°sessionStorage
                        const roomsJson = sessionStorage.getItem('connect4_rooms');
                        if (roomsJson) {
                            const rooms = JSON.parse(roomsJson);
                            const roomIndex = rooms.findIndex(r => r.id === this.roomId);
                            if (roomIndex !== -1) {
                                rooms[roomIndex].board = this.board;
                                rooms[roomIndex].currentTurn = this.currentTurn;
                                sessionStorage.setItem('connect4_rooms', JSON.stringify(rooms));
                            }
                        }
                        
                        this.updateUI();
                        return;
                    }
                }
                
                this.updateStatus('è¿™ä¸€åˆ—å·²æ»¡ï¼');
            }
            
            createEmptyBoard() {
                const board = [];
                for (let i = 0; i < 6; i++) {
                    board[i] = [0, 0, 0, 0, 0, 0, 0];
                }
                return board;
            }
            
            renderBoard() {
                const boardEl = document.getElementById('gameBoard');
                let html = '';
                
                for (let row = 0; row < 6; row++) {
                    for (let col = 0; col < 7; col++) {
                        const val = this.board[row][col];
                        let cls = 'cell';
                        if (val === 1) cls += ' red';
                        if (val === 2) cls += ' yellow';
                        
                        html += `<div class="${cls}" data-row="${row}" data-col="${col}"></div>`;
                    }
                }
                
                boardEl.innerHTML = html;
            }
            
            updateUI() {
                const joinBtn = document.getElementById('joinGameBtn');
                const resetBtn = document.getElementById('resetGameBtn');
                
                if (this.gameActive) {
                    joinBtn.innerHTML = 'ğŸ® æ¸¸æˆä¸­';
                    joinBtn.disabled = true;
                    resetBtn.disabled = false;
                    
                    document.getElementById('roomId').textContent = 
                        this.roomId ? this.roomId.substring(0, 8) + '...' : '-';
                    
                    const turnEl = document.getElementById('currentPlayer');
                    if (this.currentTurn === 'red') {
                        turnEl.innerHTML = '<div class="player-dot red-dot"></div><span>çº¢æ–¹å›åˆ</span>';
                    } else {
                        turnEl.innerHTML = '<div class="player-dot yellow-dot"></div><span>é»„æ–¹å›åˆ</span>';
                    }
                }
            }
            
            updateStatus(msg, type = '') {
                const statusEl = document.getElementById('gameStatus');
                statusEl.innerHTML = `<h2>${msg}</h2>`;
                statusEl.className = 'status ' + type;
            }
            
            resetGame() {
                this.board = this.createEmptyBoard();
                this.currentTurn = 'red';
                this.renderBoard();
                this.updateStatus('ğŸ”„ æ¸¸æˆé‡ç½®ï¼çº¢æ–¹å¼€å§‹');
                
                const roomsJson = sessionStorage.getItem('connect4_rooms');
                if (roomsJson) {
                    const rooms = JSON.parse(roomsJson);
                    const roomIndex = rooms.findIndex(r => r.id === this.roomId);
                    if (roomIndex !== -1) {
                        rooms[roomIndex].board = this.board;
                        rooms[roomIndex].currentTurn = 'red';
                        sessionStorage.setItem('connect4_rooms', JSON.stringify(rooms));
                    }
                }
                
                this.updateUI();
            }
        }
        
        // å¯åŠ¨
        document.addEventListener('DOMContentLoaded', () => {
            window.game = new FixedConnect4();
        });
    </script>
</body>
</html>